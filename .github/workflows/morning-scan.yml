name: Morning Stock Scan

on:
  schedule:
    # ë§¤ì¼ 08:10 KST (23:10 UTC ì „ë‚ ) - GitHub Actions ì§€ì—° ëŒ€ë¹„ 20ë¶„ ì—¬ìœ 
    - cron: '10 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches:
      - master

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check if market day
      id: market_check
      run: |
        python -c "
        from utils import is_market_day
        import sys
        if is_market_day():
            print('ì˜¤ëŠ˜ì€ ê°œì¥ì¼ì…ë‹ˆë‹¤.')
            print('is_market_day=true', file=open('$GITHUB_OUTPUT', 'a'))
        else:
            print('ì˜¤ëŠ˜ì€ íœ´ì¥ì¼ì…ë‹ˆë‹¤. ìŠ¤ìº”ì„ ìŠ¤í‚µí•©ë‹ˆë‹¤.')
            print('is_market_day=false', file=open('$GITHUB_OUTPUT', 'a'))
        "

    - name: Run stock screener (1ì°¨ ì‹œë„)
      id: scan1
      if: steps.market_check.outputs.is_market_day == 'true'
      continue-on-error: true
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
      run: |
        python stock_screener.py

    - name: Verify results (1ì°¨)
      id: verify1
      if: steps.scan1.outcome == 'success'
      continue-on-error: true
      run: |
        python -c "
        import json
        with open('data/morning_candidates.json') as f:
            data = json.load(f)
        count = data.get('count', 0)
        print(f'ì„ ì • ì¢…ëª©: {count}ê°œ')
        if count == 0:
            exit(1)
        "

    - name: Wait before retry (1ì°¨ ì‹¤íŒ¨ ì‹œ)
      if: steps.scan1.outcome == 'failure' || steps.verify1.outcome == 'failure'
      run: |
        echo "âš ï¸ 1ì°¨ ì‹œë„ ì‹¤íŒ¨. 60ì´ˆ í›„ ì¬ì‹œë„..."
        sleep 60

    - name: Run stock screener (2ì°¨ ì‹œë„)
      id: scan2
      if: steps.scan1.outcome == 'failure' || steps.verify1.outcome == 'failure'
      continue-on-error: true
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
      run: |
        python stock_screener.py

    - name: Verify results (2ì°¨)
      id: verify2
      if: steps.scan2.outcome == 'success'
      continue-on-error: true
      run: |
        python -c "
        import json
        with open('data/morning_candidates.json') as f:
            data = json.load(f)
        count = data.get('count', 0)
        print(f'ì„ ì • ì¢…ëª©: {count}ê°œ')
        if count == 0:
            exit(1)
        "

    - name: Wait before retry (2ì°¨ ì‹¤íŒ¨ ì‹œ)
      if: steps.scan2.outcome == 'failure' || steps.verify2.outcome == 'failure'
      run: |
        echo "âš ï¸ 2ì°¨ ì‹œë„ ì‹¤íŒ¨. 60ì´ˆ í›„ ì¬ì‹œë„..."
        sleep 60

    - name: Run stock screener (3ì°¨ ì‹œë„ - ìµœì¢…)
      id: scan3
      if: steps.scan2.outcome == 'failure' || steps.verify2.outcome == 'failure'
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
      run: |
        python stock_screener.py

    - name: Verify results (ìµœì¢…)
      if: steps.market_check.outputs.is_market_day == 'true'
      run: |
        python -c "
        import json
        with open('data/morning_candidates.json') as f:
            data = json.load(f)
        count = data.get('count', 0)
        print(f'âœ… ìµœì¢… ì„ ì • ì¢…ëª©: {count}ê°œ')
        # 0ê°œì—¬ë„ ì •ìƒ ì¢…ë£Œ (íœ´ì¥ì¼ ë“±)
        "

    - name: Export history
      if: steps.market_check.outputs.is_market_day == 'true'
      run: |
        python export_history.py

    - name: Commit and push results
      if: steps.market_check.outputs.is_market_day == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        cp data/morning_candidates.json morning_candidates.json
        cp data/history.json history.json
        git add data/morning_candidates.json morning_candidates.json data/history.json history.json
        # DB íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ ì¶”ê°€
        [ -f data/morning_candidates.db ] && git add data/morning_candidates.db || true
        git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ”® ì¥ì „ ì¢…ëª© ì„ ì • - $(date +'%Y-%m-%d %H:%M')" && git push) || true
